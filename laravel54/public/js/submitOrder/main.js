/* @update: 2017-10-31 19:56:56 */ 
seajs.config({comboExcludes:eval(globalVar.comboExcludes),paths:{baseServer:"//sp.jd.com/payment/2.0.0/",project:globalVar.jsPath,unit:"//sp.jd.com/payment/2.0.0/js/unit"},alias:{avalon:"baseServer/js/lib/avalon.min.js",common:"baseServer/js/common.js",lodash:"baseServer/js/lib/lodash.min.js"}}),seajs.use(["project/controller/cashier.commons.js","project/controller/quick.js","unit/modal","unit/shortPassword","unit/longPassword","project/component/area-newUser","project/component/pay-baitiao","project/component/pay-baitiaoQuick","project/component/pay-bankCard","project/component/pay-xjk","project/component/pay-qbb","project/component/pay-gb","project/component/pay-jdbalance","project/component/pay-jingbean","project/component/pay-jincai","project/component/modal-message","project/component/modal-newCardWangyin","project/component/modal-combo","project/component/modal-alert"],function(){avalon.ready(function(){paymentUI.isCss3Support()?avalon.effect("animate",{enterClass:"animate-enter",enterActiveClass:"animate-enter-active",leaveClass:"animate-leave",leaveActiveClass:"animate-leave-active"}):avalon.effect("animate",{enter:function(a,e){$(a).show(e)},leave:function(a,e){$(a).hide(e)}});var a=avalon.define({$id:"vmPayment",data:{},agencyChannelList:[],agencyTip:"",jdPayTip:"",channelSelected:[],isNewUser:!1,isShowMore:!1,cvv2:"",password:"",paymentFlag:!1,pwdLevel:"",isCVV2:!1,payLoading:!1,errorInfo:"",newUserMarketDesc:"",orderInitType:"",more:function(){_.forEach(avalon.vmodels,function(a){"undefined"!=typeof a&&"undefined"!=typeof a.channelId&&(a.isVisible=!0)}),this.isShowMore=!1},showNewCardWangyin:function(a){avalon.vmodels.modal_newCardWangyin.show(),avalon.vmodels.modal_newCardWangyin.tabToggle(a),_.forEach(avalon.vmodels,function(a){"undefined"!=typeof a&&"undefined"!=typeof a.channelId&&(a.channelCheck=!1)})},showMessageAuth:function(a){if(this.paymentFlag){var e=avalon.vmodels.modal_message;e.data=a,e.clearAuthCode(),e.show()}},afterLoading:function(){$(".pay-loading").remove()},showComboResult:function(a){avalon.vmodels.modal_combo.data=a,avalon.vmodels.modal_combo.show()},showModalAlert:function(a){avalon.vmodels.modal_alert.setData(a),avalon.vmodels.modal_alert.show()},commitPay:channelPay.commitPay,platConfirm:platPay.platConfirm,weixinConfirm:platPay.weixinConfirm});a.$watch("password",function(){this.errorInfo=""}),a.$watch("channelSelected",function(a){if(this.errorInfo="",this.password="",this.cvv2="",a.length<2&&_.forEach(avalon.vmodels,function(a){"undefined"!=typeof a&&"undefined"!=typeof a.channelId&&(a.channelDesc=a.data.canNotUseDesc,a.canUse=a.data.canUse)}),void 0==a||a.length<1)return this.isCVV2=!1,this.pwdLevel="",this.paymentFlag=!1,void 0;switch(2==a.length?!avalon.vmodels[a[0]].data.needCombine&&(avalon.vmodels[a[0]].channelCheck=!1):3==a.length&&(avalon.vmodels[a[1]].channelCheck=!1),a.length){case 1:var e=avalon.vmodels[a[0]],n=!0;if(this.pwdLevel=e.data.pwdLevel,this.isCVV2="undefined"==typeof e.data.bindingCardInfo?"":e.data.bindingCardInfo.isCVV2,"BANKCARD"==e.data.channelType){var o=e.data.maxPayableAmount;"undefined"!=typeof o&&Number(o)<Number(globalVar.shouldPay)&&(e.payAmount=Number(o).toFixed(2),n=!1,this.errorInfo="\u5355\u7b14\u8ba2\u5355\u91d1\u989d\u8d85\u9650\uff0c\u8bf7\u9009\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f")}else if(Number(e.data.maxPayableAmount)<Number(globalVar.shouldPay)){var t=e.data.maxPayableAmount;e.payAmount=Number(t).toFixed(2);var i=Number(Number(globalVar.shouldPay)-Number(t)).toFixed(2);this.errorInfo="\u60a8\u8fd8\u5dee"+i+"\u5143\uff0c\u8bf7\u7ee7\u7eed\u9009\u62e9\u652f\u4ed8\u65b9\u5f0f",n=!1,_.forEach(avalon.vmodels,function(a){"undefined"!=typeof a&&"undefined"!=typeof a.channelId&&a.canUse&&a.channelId!=e.channelId&&"undefined"!=typeof a.data.maxPayableAmount&&Number(a.data.maxPayableAmount)<Number(i)&&(a.channelDesc="\u6b64\u7ec4\u5408\u65b9\u5f0f\u4e0d\u8db3\u4ee5\u652f\u4ed8\u8ba2\u5355\u91d1\u989d",a.canUse=!1)})}n?(this.paymentFlag=!0,e.payAmount=Number(globalVar.shouldPay).toFixed(2)):this.paymentFlag=!1;break;case 2:var t=Number(globalVar.shouldPay)-Number(avalon.vmodels[a[0]].data.maxPayableAmount),d=avalon.vmodels[a[1]];d.payAmount=Number(t).toFixed(2),this.paymentFlag=!0,this.isCVV2="undefined"==typeof d.data.bindingCardInfo?"":d.data.bindingCardInfo.isCVV2}});var e=function(a){$.ajax({type:"post",url:"/cashier/getCashierPayChannels",contentType:"application/json",dataType:"json",data:JSON.stringify({paySign:globalVar.paySign,orderId:globalVar.orderId,pageId:globalVar.pageId}),success:function(e){a(e)},error:function(){a({})}})},n=function(a){$.ajax({type:"post",contentType:"application/json",dataType:"json",data:JSON.stringify({paySign:globalVar.paySign,orderId:globalVar.orderId,riskReqVo:globalVar.riskInfo}),url:"/cashier/getCashierAgencyChannels",success:function(e){"undefined"!==e&&e.success===!0&&a(e)}})},o=function(a){$.ajax({type:"get",contentType:"application/json",dataType:"html",data:{paySign:globalVar.paySign,orderId:globalVar.orderId},url:"/async/queryOrderDeleteTip",success:function(e){a(e)}})},t=function(a){$.ajax({type:"post",contentType:"application/json",dataType:"html",data:JSON.stringify({paySign:globalVar.paySign,orderId:globalVar.orderId,riskReqVo:globalVar.riskInfo,pageId:globalVar.pageId}),url:"/async/getNewUserMarkting",success:function(e){a(e)}})};e(function(e){globalVar.virtualType="undefined"==typeof e.virtualType?"":e.virtualType,a.data=e;var i=e.payChannelList;if("0"==e.newUser){a.isNewUser=0,i.length>3&&(a.isShowMore=!0);var d="<xmp ms-widget=\"{is:'ms-baitiao', $id:'vmBaitiao', data:{data}}\"></xmp>",s="<xmp ms-widget=\"{is:'ms-baitiaoQuick', $id:'vmBaitiaoQuick', data:{data}}\"></xmp>",r="<xmp ms-widget=\"{is:'ms-bankCard', $id:'vmBankCard_{bankID}', data:{data}}\"></xmp>",l="<xmp ms-widget=\"{is:'ms-xjk', $id:'vmBankCard_xjk', data:{data}}\"></xmp>",m="<xmp ms-widget=\"{is:'ms-qbb', $id:'vmBankCard_qbb', data:{data}}\"></xmp>",c="<xmp ms-widget=\"{is:'ms-gb', $id:'vmBankCard_gb', data:{data}}\"></xmp>",p="<xmp ms-widget=\"{is:'ms-jdbalance', $id:'vmBankCard_jdbalance', data:{data}}\"></xmp>",y="<xmp ms-widget=\"{is:'ms-jingbean', $id:'vmBankCard_jingbean', data:{data}}\"></xmp>",u="<xmp ms-widget=\"{is:'ms-jincai', $id:'vmBankCard_jincai', data:{data}}\"></xmp>";$("#payChanel").empty();var f="";_.forEach(e.payChannelList,function(a,e){switch(a.channelType){case"BANKCARD":f+=r.replace("{bankID}",a.channelId).replace("{data}","@data.payChannelList["+e+"]");break;case"BAITIAO":f+=d.replace("{data}","@data.payChannelList["+e+"]");break;case"BAITIAOQUICK":f+=s.replace("{data}","@data.payChannelList["+e+"]");break;case"XJK":f+=l.replace("{data}","@data.payChannelList["+e+"]");break;case"QBB":f+=m.replace("{data}","@data.payChannelList["+e+"]");break;case"GB":f+=c.replace("{data}","@data.payChannelList["+e+"]");break;case"JDBALANCE":f+=p.replace("{data}","@data.payChannelList["+e+"]");break;case"JINGBEAN":f+=y.replace("{data}","@data.payChannelList["+e+"]");break;case"JINCAI":f+=u.replace("{data}","@data.payChannelList["+e+"]")}}),$("#payChanel").html(f)}else switch(e.newUser){case"1":a.isNewUser=1;break;case"2":a.isNewUser=2,globalVar.newUser=2;break;default:a.isNewUser=1}var h="",g="<xmp ms-widget=\"{is:'ms-modal-message', $id:'modal_message', modalClass:'verification-modal', title: '\u652f\u4ed8XXXXX\u5143'}\"></xmp>",b="<xmp ms-widget=\"{is:'ms-modal-newCardWangyin', $id:'modal_newCardWangyin', modalClass:'newCard-modal'}\"></xmp>",v="<xmp ms-widget=\"{is:'ms-modal-combo', $id:'modal_combo', modalClass:'ui-modal-error wangyin-modal', title: '\u7ec4\u5408\u652f\u4ed8\u7ed3\u679c'}\"></xmp>",w="<xmp ms-widget=\"{is:'ms-modal-alert', $id:'modal_alert', modalClass:'ui-modal wangyin-modal-success'}\"></xmp>";h+=g,h+=b,h+=v,h+=w,$("#modals").append(h);try{avalon.scan(document.body)}catch(C){"undefined"!=typeof globalVar.oldCashierURL&&""!=globalVar.oldCashierURL&&(window.location.href=globalVar.oldCashierURL+"&errorInfo="+C.stack)}"undefined"!=typeof e.jdPayTip&&""!=e.jdPayTip&&2!=a.isNewUser&&(a.jdPayTip=e.jdPayTip),setTimeout(function(){a.orderInitType=2==a.isNewUser?"order-init-newUser":"order-init-oldUser"},10),setTimeout(function(){$(".pay-loading").remove(),"undefined"!=typeof avalon.vmodels.unit_shortPassword&&(avalon.vmodels.unit_shortPassword.pwdEnterCallback=function(){a.commitPay()})},1500),n(function(e){a.agencyChannelList=e.agencyChannelList,"undefined"!=typeof e.agencyTip&&""!=e.agencyTip&&(a.agencyTip=e.agencyTip)}),(1==a.isNewUser||2==a.isNewUser)&&t(function(e){"undefined"!=typeof e&&""!=e&&(1==a.isNewUser?a.newUserMarketDesc=e:avalon.vmodels.vmNewUser.newUserMarketDesc="\xb7 "+e)}),o(function(a){if("undefined"!=typeof a&&""!=a&&($("#deleteOrderTip").html(a),$(".j_orderTime").length>0)){var e=$(".j_orderTime").attr("data-time");paymentUI.setOrderCountdown(".j_orderTime",e,function(){window.location.reload()})}}),initLargeLoad(),initGTM(),initRader()})})});